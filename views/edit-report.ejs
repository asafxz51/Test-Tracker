<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <title>Edit Test - Test Tracker</title>
   <link rel="stylesheet" href="/css/styles.css">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
      /* CSS for the dynamic steps section */
      .step-input-group {
         display: flex;
         align-items: center;
         /* Vertically aligns items to the center */
         margin-bottom: 10px;
         gap: 10px;
         /* Adds spacing between elements */
      }

      .step-number {
         font-weight: bold;
         flex-shrink: 0;
         /* Prevents the number from shrinking */
      }

      .step-input-group input[type="text"] {
         flex-grow: 1;
         /* Makes the input field take up all available space */
         margin: 0;
      }

      .remove-step-btn {
         flex-shrink: 0;
         /* Prevents the button from shrinking */
         font-weight: bold;

         /* --- Sizing for a small, circular 'X' button --- */
         border-radius: 50%;
         /* Makes it a circle */
         width: 30px;
         height: 30px;
         padding: 0;
         font-size: 16px;
         line-height: 1;
         min-width: auto;
      }
   </style>
</head>

<body>
   <div class="form-container">
      <h1>Edit Test Case</h1>
      <form action="/edit/<%= report._id %>" method="POST">

         <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="<%= report.title %>" required>
         </div>

         <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="4"><%= report.description %></textarea>
         </div>

         <div class="form-group">
            <label for="type">Type</label>
            <select id="type" name="type">
               <option <%=report.type==='Functional' ? 'selected' : '' %>>Functional</option>
               <option <%=report.type==='Regression' ? 'selected' : '' %>>Regression</option>
               <option <%=report.type==='Smoke' ? 'selected' : '' %>>Smoke</option>
               <option <%=report.type==='UI' ? 'selected' : '' %>>UI</option>
               <option <%=report.type==='API' ? 'selected' : '' %>>API</option>
            </select>
         </div>

         <div class="form-group">
            <label for="priority">Priority</label>
            <select id="priority" name="priority">
               <option <%=report.priority==='Low' ? 'selected' : '' %>>Low</option>
               <option <%=report.priority==='Medium' ? 'selected' : '' %>>Medium</option>
               <option <%=report.priority==='High' ? 'selected' : '' %>>High</option>
            </select>
         </div>

         <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
               <option <%=report.status==='Not Executed' ? 'selected' : '' %>>Not Executed</option>
               <option <%=report.status==='In Progress' ? 'selected' : '' %>>In Progress</option>
               <option <%=report.status==='Passed' ? 'selected' : '' %>>Passed</option>
               <option <%=report.status==='Failed' ? 'selected' : '' %>>Failed</option>
               <option <%=report.status==='Blocked' ? 'selected' : '' %>>Blocked</option>
            </select>
         </div>

         <div class="form-group">
            <label for="preconditions">Preconditions</label>
            <textarea id="preconditions" name="preconditions" rows="2"><%= report.preconditions %></textarea>
         </div>

         <!-- DYNAMIC STEPS SECTION -->
         <div class="form-group">
            <label for="steps">Test Steps</label>
            <div id="steps-container">
               <% if (report.steps && report.steps.length> 0) { %>
                  <% report.steps.forEach(function(step) { %>
                     <div class="step-input-group">
                        <span class="step-number"></span>
                        <input type="text" name="steps" value="<%= step %>" required>
                        <button type="button" class="button button-danger remove-step-btn">X</button>
                     </div>
                     <% }); %>
                        <% } else { %>
                           <div class="step-input-group">
                              <span class="step-number">1.</span>
                              <input type="text" name="steps" placeholder="Enter a test step" required>
                              <button type="button" class="button button-danger remove-step-btn">X</button>
                           </div>
                           <% } %>
            </div>
            <button type="button" id="add-step-btn" class="button">Add Step</button>
         </div>

         <div class="form-group">
            <label for="expected">Expected Result</label>
            <textarea id="expected" name="expected" rows="2"><%= report.expected %></textarea>
         </div>

         <div class="form-group">
            <label for="actual">Actual Result</label>
            <textarea id="actual" name="actual" rows="2"><%= report.actual %></textarea>
         </div>

         <div class="form-actions">
            <button type="submit" class="button">Update Report</button>
            <a href="/" class="button button-secondary">Cancel</a>
         </div>

      </form>
   </div>

   <script>
      document.addEventListener('DOMContentLoaded', function () {
         const stepsContainer = document.getElementById('steps-container');
         const addStepBtn = document.getElementById('add-step-btn');

         function renumberSteps() {
            const stepGroups = stepsContainer.querySelectorAll('.step-input-group');
            stepGroups.forEach((group, index) => {
               group.querySelector('.step-number').textContent = `${index + 1}.`;
            });
         }

         addStepBtn.addEventListener('click', () => {
            const newStepGroup = document.createElement('div');
            newStepGroup.classList.add('step-input-group');
            newStepGroup.innerHTML = `
                    <span class="step-number"></span>
                    <input type="text" name="steps" placeholder="Enter a test step" required>
                    <button type="button" class="button button-danger remove-step-btn">X</button>
                `;
            stepsContainer.appendChild(newStepGroup);
            renumberSteps();
         });

         stepsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-step-btn')) {
               if (stepsContainer.children.length > 1) {
                  e.target.parentElement.remove();
                  renumberSteps();
               } else {
                  alert('You must have at least one step.');
               }
            }
         });

         renumberSteps();
      });
   </script>
</body>

</html>